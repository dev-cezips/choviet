<% if message.system_message? %>
  <!-- System Message -->
  <% if message.content_raw.include?('âœ…') %>
    <!-- Transaction Complete Message -->
    <div class="text-center text-sm text-gray-600 my-4" data-message-id="<%= message.id %>">
      <div class="inline-block bg-gray-100 rounded-lg px-4 py-2">
        <%= message.display_content %>
      </div>
      <div class="text-xs text-gray-500 mt-1">
        <%= message.created_at.strftime("%H:%M") %>
      </div>
    </div>
  <% else %>
    <!-- System Notice -->
    <div class="mb-4 mx-auto max-w-md" data-message-id="<%= message.id %>">
      <%= render "shared/alert_panel",
          variant: :tip,
          icon: "ðŸ’¡",
          title: "ThÃ´ng bÃ¡o tá»« há»‡ thá»‘ng",
          body: message.display_content %>
      <div class="mt-2 text-center">
        <span class="text-xs text-amber-600"><%= message.created_at.strftime("%H:%M") %></span>
      </div>
    </div>
  <% end %>
<% else %>
  <!-- Regular Message -->
  <div class="mb-4 <%= message.sender_id == current_user&.id ? 'text-right' : 'text-left' %>" 
       data-message-id="<%= message.id %>">
    <div class="<%= message.sender_id == current_user&.id ? 'inline-block' : 'flex items-end gap-2' %>">
    <!-- Avatar for other user's messages -->
    <% unless message.sender_id == current_user&.id %>
      <%= link_to user_path(message.sender), class: "flex-shrink-0" do %>
        <%= user_avatar(message.sender, size: "w-8 h-8", text_size: "text-xs") %>
      <% end %>
    <% end %>
    
    <!-- Message Bubble -->
    <div class="inline-block max-w-xs lg:max-w-md">
      <div class="<%= message.sender_id == current_user&.id ? 'bg-blue-600 text-white' : 'bg-white border border-gray-300' %> rounded-lg px-4 py-2 shadow-sm">
        <p class="whitespace-pre-wrap break-words" id="message-content-<%= message.id %>">
          <%= message.display_content %>
        </p>
      </div>
      
      <!-- Message Info & Actions -->
      <div class="flex items-center mt-1 <%= message.sender_id == current_user&.id ? 'justify-end' : 'justify-start' %> space-x-2">
        <span class="text-xs text-gray-500">
          <%= message.created_at.strftime("%H:%M") %>
        </span>
        
        <% if message.content_translated.present? %>
          <button class="text-xs text-gray-500 hover:text-gray-700" 
                  data-action="click->message#toggleOriginal"
                  data-message-target="toggleBtn"
                  data-original="<%= message.content_raw %>"
                  data-translated="<%= message.content_translated %>">
            Xem gá»‘c
          </button>
        <% end %>
        
        <% if message.sender_id == current_user&.id && message.read_at.present? %>
          <span class="text-xs text-gray-500">âœ“âœ“</span>
        <% elsif message.sender_id == current_user&.id %>
          <span class="text-xs text-gray-400">âœ“</span>
        <% end %>
      </div>
    </div>
    
    <!-- Suspicious Content Notice -->
    <% if suspicious_message?(message.display_content) && message.sender_id != current_user&.id %>
      <div class="mt-2 mx-auto max-w-xs">
        <% report_link = link_to(new_message_report_path(message),
            data: { turbo_frame: "report_modal" },
            class: "inline-flex items-center text-xs text-red-600 hover:text-red-700 font-medium") do %>
          ðŸš¨ BÃ¡o cÃ¡o tin nháº¯n nÃ y
        <% end %>
        <%= render "shared/alert_panel",
            variant: :warning,
            icon: "âš ï¸",
            title: "LÆ°u Ã½:",
            body: "Tin nháº¯n nÃ y cÃ³ thá»ƒ chá»©a ná»™i dung khÃ´ng an toÃ n. HÃ£y cáº©n tháº­n vá»›i viá»‡c chuyá»ƒn tiá»n trÆ°á»›c hoáº·c chia sáº» thÃ´ng tin cÃ¡ nhÃ¢n.",
            actions: report_link %>
      </div>
    <% end %>
</div>

<script>
  // Toggle between original and translated content
  document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.querySelector('[data-message-target="toggleBtn"][data-message-id="<%= message.id %>"]');
    if (toggleBtn) {
      let showingOriginal = false;
      
      toggleBtn.addEventListener('click', function() {
        const contentEl = document.getElementById('message-content-<%= message.id %>');
        
        if (showingOriginal) {
          contentEl.textContent = this.dataset.translated;
          this.textContent = 'Xem gá»‘c';
        } else {
          contentEl.textContent = this.dataset.original;
          this.textContent = 'Xem báº£n dá»‹ch';
        }
        
        showingOriginal = !showingOriginal;
      });
    }
  });
</script>
<% end %>