<div class="bg-gray-50">
  <!-- Images Section -->
  <%= render "posts/image_slider", images: @post.images %>
  
  <% unless @post.images.attached? && @post.images.any? %>
    <!-- No Image Placeholder -->
    <div class="relative bg-gray-100">
      <div class="h-64 md:h-96 flex items-center justify-center">
        <div class="text-center">
          <svg class="w-24 h-24 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p class="mt-2 text-sm text-gray-500">Kh√¥ng c√≥ h√¨nh ·∫£nh</p>
        </div>
      </div>
    </div>
  <% end %>

  <div class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- First Trade Banner -->
    <% if user_signed_in? && current_user.first_trade? && @post.user != current_user %>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-4 flex items-start gap-3">
        <span class="text-2xl">üòä</span>
        <div class="flex-1">
          <p class="font-medium text-blue-900 mb-1">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi giao d·ªãch ƒë·∫ßu ti√™n!</p>
          <p class="text-sm text-blue-700">Ch√∫ng t√¥i s·∫Ω h∆∞·ªõng d·∫´n b·∫°n ƒë·ªÉ giao d·ªãch thu·∫≠n l·ª£i.</p>
        </div>
      </div>
    <% end %>
    
    <!-- Post Info -->
    <div class="bg-white rounded-lg shadow-sm p-4 md:p-6">
      <!-- Title and Price -->
      <h1 class="text-xl md:text-2xl font-bold text-gray-900 mb-2"><%= @post.title %></h1>
      
      <% if @post.marketplace? && @post.product %>
        <p class="text-2xl font-bold text-soft-coral mb-4">
          <%= price_display(@post.product.price) %>
        </p>
      <% end %>
      
      <!-- Meta Info -->
      <div class="flex items-center gap-4 text-sm text-gray-500 mb-4">
        <div class="flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          <span>L∆∞·ª£t xem: <%= @post.views_count %></span>
        </div>
        <span>‚Ä¢</span>
        <span><%= time_ago_in_words(@post.created_at) %> tr∆∞·ªõc</span>
      </div>
      
      <!-- Category Badge -->
      <div class="mb-4">
        <%= category_badge(@post) %>
      </div>
      
      <!-- Content -->
      <div class="prose prose-gray max-w-none mb-6">
        <%= simple_format(@post.content) %>
      </div>
      
      <% if @post.marketplace? && @post.product %>
        <!-- Product Condition -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-gray-600 mb-1">T√¨nh tr·∫°ng</p>
          <p class="font-medium">
            <% case @post.product.condition %>
            <% when 'new_item' %>
              üÜï M·ªõi 100%
            <% when 'like_new' %>
              ‚ú® Nh∆∞ m·ªõi
            <% when 'good' %>
              üëç T·ªët
            <% when 'fair' %>
              üîÑ B√¨nh th∆∞·ªùng
            <% when 'poor' %>
              ‚ö†Ô∏è C≈©
            <% end %>
          </p>
        </div>
      <% end %>
    </div>

    <!-- Low Reputation Warning -->
    <% if @post.user.low_reputation? %>
      <div class="bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-lg mb-3 text-sm flex items-start gap-3 mt-4">
        <span class="text-lg">üí°</span>
        <div>
          <p class="font-medium mb-1">L∆∞u √Ω khi giao d·ªãch</p>
          <p>Ng∆∞·ªùi d√πng n√†y ƒëang x√¢y d·ª±ng uy t√≠n. B·∫°n c√≥ th·ªÉ trao ƒë·ªïi th√™m ƒë·ªÉ hi·ªÉu r√µ h∆°n tr∆∞·ªõc khi quy·∫øt ƒë·ªãnh.</p>
        </div>
      </div>
    <% end %>
    
    <!-- Seller Info -->
    <div class="bg-white rounded-lg shadow-sm p-4 md:p-6 mt-4">
      <h3 class="font-semibold text-gray-900 mb-4">Th√¥ng tin ng∆∞·ªùi b√°n</h3>
      
      <%= link_to user_path(@post.user), class: "flex items-center gap-3" do %>
        <% if @post.user.avatar.attached? %>
          <%= image_tag @post.user.avatar, class: "w-12 h-12 rounded-full object-cover" %>
        <% elsif @post.user.avatar_url.present? %>
          <%= image_tag @post.user.avatar_url, class: "w-12 h-12 rounded-full object-cover" %>
        <% else %>
          <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
            <%= @post.user.display_name.first.upcase %>
          </div>
        <% end %>
        <div class="flex-1">
          <p class="font-semibold text-gray-900"><%= @post.user.display_name %></p>
          <p class="text-xs text-gray-500">Tham gia: <%= l(@post.user.created_at.to_date, format: :short) %></p>
        </div>
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      <% end %>
      
      <!-- Trust Summary -->
      <div class="mt-3 px-2">
        <p class="text-sm text-gray-600"><%= @post.user.trust_summary(context: :post) %></p>
        <% if @post.user.trust_hint(context: :post).present? %>
          <p class="text-xs text-gray-500 mt-1"><%= @post.user.trust_hint(context: :post) %></p>
        <% end %>
      </div>
      
      <!-- DM Button (V1 Chat) -->
      <% if user_signed_in? && @post.user != current_user %>
        <div class="mt-3">
          <%= button_to dm_post_path(@post), method: :post,
              class: "w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-medium hover:bg-blue-100 transition-colors" do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
            <span>Nh·∫Øn tin ri√™ng</span>
          <% end %>
        </div>
      <% end %>
      
      <% if @post.location %>
        <div class="mt-4 pt-4 border-t">
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span><%= location_display(@post.location) %></span>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Action Buttons -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 flex gap-4 md:hidden shadow-lg">
      <div id="post_likes_<%= @post.id %>" class="flex-shrink-0">
        <%= render partial: 'posts/like_button_detail', locals: { post: @post } %>
      </div>
      
      <% if @post.user != current_user %>
        <% if user_signed_in? && current_user.no_reviews? %>
          <div class="flex flex-col items-center gap-2">
            <button disabled class="flex items-center justify-center gap-2 px-4 py-3 bg-gray-200 text-gray-400 rounded-lg font-medium cursor-not-allowed w-full min-h-[44px]">
              <span class="text-xl">üí¨</span>
              <span>Chat</span>
            </button>
            <p class="text-xs text-orange-600 text-center">
              ‚ö†Ô∏è C·∫ßn c√≥ √≠t nh·∫•t 1 ƒë√°nh gi√° ƒë·ªÉ b·∫Øt ƒë·∫ßu giao d·ªãch
            </p>
          </div>
        <% else %>
          <%= button_to post_chat_rooms_path(@post), method: :post,
              class: "flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 text-gray-600 rounded-lg font-medium hover:bg-gray-200 transition-colors min-h-[44px]" do %>
            <span class="text-xl">üí¨</span>
            <span>Chat</span>
          <% end %>
        <% end %>
      <% end %>
      
      <% if @post.user == current_user %>
        <%= link_to "Ch·ªânh s·ª≠a", edit_post_path(@post), 
            class: "flex-1 bg-gray-100 text-gray-700 rounded-lg py-3 font-medium text-center min-h-[44px] flex items-center justify-center" %>
      <% else %>
        <%= button_to post_chat_rooms_path(@post), method: :post,
            class: "flex-1 bg-zalo-blue text-white rounded-lg py-3 font-bold text-center min-h-[44px]" do %>
          Nh·∫Øn tin v·ªõi ng∆∞·ªùi b√°n
        <% end %>
      <% end %>
    </div>

    <!-- Desktop Action Buttons -->
    <div class="hidden md:block bg-white rounded-lg shadow-sm p-6 mt-4">
      <div class="flex gap-3">
        <div id="post_likes_desktop_<%= @post.id %>" class="flex-shrink-0">
          <%= render partial: 'posts/like_button_detail', locals: { post: @post } %>
        </div>
        
        <% if @post.user != current_user %>
          <% if user_signed_in? && current_user.no_reviews? %>
            <div class="flex flex-col items-center gap-2">
              <button disabled class="flex items-center justify-center gap-2 px-4 py-3 bg-gray-200 text-gray-400 rounded-lg font-medium cursor-not-allowed w-full min-h-[44px]">
                <span class="text-xl">üí¨</span>
                <span>Chat</span>
              </button>
              <p class="text-xs text-orange-600 text-center">
                ‚ö†Ô∏è C·∫ßn c√≥ √≠t nh·∫•t 1 ƒë√°nh gi√° ƒë·ªÉ b·∫Øt ƒë·∫ßu giao d·ªãch
              </p>
            </div>
          <% else %>
            <%= button_to post_chat_rooms_path(@post), method: :post,
                class: "flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 text-gray-600 rounded-lg font-medium hover:bg-gray-200 transition-colors min-h-[44px]" do %>
              <span class="text-xl">üí¨</span>
              <span>Chat</span>
            <% end %>
          <% end %>
        <% end %>
        
        <% if @post.user == current_user %>
          <%= link_to "Ch·ªânh s·ª≠a", edit_post_path(@post), 
              class: "flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg py-3 font-medium text-center transition" %>
          <%= button_to "X√≥a b√†i", @post, method: :delete, 
              data: { turbo_confirm: "B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?" },
              class: "px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition cursor-pointer" %>
        <% else %>
          <%= button_to post_chat_rooms_path(@post), method: :post,
              class: "flex-1 bg-zalo-blue hover:bg-blue-700 text-white rounded-lg py-3 font-bold text-center transition" do %>
            Nh·∫Øn tin v·ªõi ng∆∞·ªùi b√°n
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- More Menu (Report) -->
    <% if @post.user != current_user %>
      <div class="text-center mt-6">
        <%= link_to new_post_report_path(@post), 
            data: { turbo_frame: "report_modal" },
            class: "inline-flex items-center gap-2 text-sm text-gray-500 hover:text-red-600" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
          B√°o c√°o b√†i vi·∫øt
        <% end %>
      </div>
    <% end %>

    <!-- Related Posts -->
    <div class="bg-white rounded-lg shadow-sm p-4 md:p-6 mt-6 mb-24 md:mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Tin ƒëƒÉng kh√°c c·ªßa ng∆∞·ªùi b√°n</h2>
      <div class="space-y-3">
        <% @post.user.posts.where.not(id: @post.id).limit(3).each do |post| %>
          <%= link_to post, class: "block p-3 hover:bg-gray-50 rounded-lg transition-colors" do %>
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="font-medium text-gray-900"><%= post.title %></h3>
                <p class="text-sm text-gray-600 mt-1"><%= truncate(post.content, length: 60) %></p>
              </div>
              <% if post.marketplace? && post.product %>
                <span class="text-soft-coral font-medium whitespace-nowrap ml-3">
                  <%= price_display(post.product.price) %>
                </span>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Report Modal Frame -->
<turbo-frame id="report_modal"></turbo-frame>

<!-- Lightbox Modal (Î∂ÑÎ¶¨Îêú Ïª¥Ìè¨ÎÑåÌä∏) -->
<%= render "shared/lightbox" %>