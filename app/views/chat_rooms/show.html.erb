<div class="container mx-auto px-4 py-6">
  <div class="max-w-2xl mx-auto">
    <!-- Review Reward Message -->
    <% if flash[:reward].present? %>
      <style>
        @keyframes subtle-pulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.9; transform: scale(1.02); }
        }
        .animate-subtle-pulse {
          animation: subtle-pulse 2s ease-in-out;
        }
      </style>
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-3 shadow-sm animate-subtle-pulse">
        <div class="flex items-start gap-3">
          <span class="text-2xl"><%= flash[:reward][:first_review] ? "üåü" : "‚≠ê" %></span>
          <div class="flex-1">
            <p class="font-medium text-green-900"><%= flash[:reward][:title] %></p>
            <p class="text-sm text-green-700 mt-1"><%= flash[:reward][:message] %></p>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- First Trade Banner -->
    <% if current_user.first_trade? %>
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-3 flex items-start gap-3">
        <span class="text-2xl">üí°</span>
        <div class="flex-1">
          <p class="font-medium text-blue-900 mb-1">ƒê√¢y l√† giao d·ªãch ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
          <p class="text-sm text-blue-700">H√£y trao ƒë·ªïi r√µ r√†ng v·ªÅ gi√° c·∫£, t√¨nh tr·∫°ng s·∫£n ph·∫©m v√† c√°ch th·ª©c giao h√†ng nh√©.</p>
        </div>
      </div>
    <% end %>
    
    <!-- Review Reminder Banner (24h after completion, dismissible) -->
    <% if @show_review_reminder %>
      <% review_link = link_to(new_post_chat_room_review_path(@post, @chat_room),
          class: "inline-flex items-center gap-1 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors") do %>
        <span>üìù</span>
        <span>ƒê√°nh gi√° ngay</span>
      <% end %>
      <%= render "shared/dismissible_alert",
          id: "review-reminder",
          variant: :info,
          icon: "üôÇ",
          title: "Giao d·ªãch n√†y th·∫ø n√†o?",
          body: "30 gi√¢y ƒë·ªÉ ƒë√°nh gi√° s·∫Ω gi√∫p c·ªông ƒë·ªìng tin c·∫≠y h∆°n!",
          actions: review_link,
          dismiss_url: dismiss_review_reminder_post_chat_room_path(@post, @chat_room),
          class_name: "mb-3" %>
    <% end %>
    
    <!-- Low Reputation Notice -->
    <% other_user = @chat_room.other_user(current_user) %>
    <% if other_user.low_reputation? %>
      <%= render "shared/alert_panel",
          variant: :tip,
          icon: "üí°",
          title: "G·ª£i √Ω an to√†n",
          body: "Ng∆∞·ªùi d√πng n√†y ƒëang x√¢y d·ª±ng uy t√≠n. H√£y trao ƒë·ªïi k·ªπ v√† x√°c nh·∫≠n r√µ th√¥ng tin tr∆∞·ªõc khi giao d·ªãch nh√©!",
          class_name: "mb-3" %>
    <% end %>
    
    <!-- Chat Header -->
    <div class="bg-white rounded-t-lg shadow-sm p-4 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <%= link_to @post, class: "text-gray-600 hover:text-gray-800" do %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        <% end %>
        
        <%= user_avatar(other_user, size: "w-10 h-10", text_size: "text-base") %>
        
        <div>
          <h3 class="font-semibold text-gray-900"><%= other_user.display_name %></h3>
          <p class="text-xs text-gray-600"><%= @post.title %></p>
          <p class="text-xs text-gray-500 mt-1"><%= other_user.trust_summary(context: :chat) %></p>
          <% if other_user.trust_hint(context: :chat).present? %>
            <p class="text-xs text-gray-400 mt-0.5"><%= other_user.trust_hint(context: :chat) %></p>
          <% end %>
        </div>
      </div>
      
      <!-- Trade Status Badge -->
      <div class="flex items-center space-x-3">
        <% if @chat_room.trade_status.present? %>
          <%= render "shared/badge",
              icon: trade_status_icon(@chat_room),
              label: trade_status_label(@chat_room),
              class_name: trade_status_badge_class(@chat_room) %>
        <% end %>
        
        <button class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Trade Status Actions (for seller only) -->
    <% if current_user == @chat_room.seller && @chat_room.trade_status != 'completed' %>
      <div class="bg-gray-50 border-t border-gray-200 p-3 flex items-center justify-between">
        <p class="text-sm text-gray-600">C·∫≠p nh·∫≠t tr·∫°ng th√°i giao d·ªãch:</p>
        <div class="flex gap-2">
          <% if @chat_room.negotiating? %>
            <%= button_to "‚úÖ Ho√†n t·∫•t", 
                update_status_post_chat_room_path(@post, @chat_room, status: 'completed'),
                method: :patch,
                class: "px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-colors",
                data: { 
                  turbo_method: :patch,
                  turbo_confirm: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√°nh d·∫•u giao d·ªãch n√†y l√† ho√†n t·∫•t?" 
                } %>
            <%= button_to "‚ùå H·ªßy", 
                update_status_post_chat_room_path(@post, @chat_room, status: 'cancelled'),
                method: :patch,
                class: "px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded-md text-sm font-medium transition-colors",
                data: { turbo_method: :patch } %>
          <% elsif @chat_room.cancelled? %>
            <%= button_to "üîÑ M·ªü l·∫°i", 
                update_status_post_chat_room_path(@post, @chat_room, status: 'negotiating'),
                method: :patch,
                class: "px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors",
                data: { turbo_method: :patch } %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Messages Area -->
    <div class="bg-gray-50 h-96 overflow-y-auto p-4" id="messages"
         data-controller="messages"
         data-messages-current-user-id-value="<%= current_user.id %>"
         data-messages-chat-room-id-value="<%= @chat_room.id %>">
      <%= turbo_stream_from "chat_room_#{@chat_room.id}" %>
      
      <div id="messages-container" data-messages-target="container">
        <% if @messages.empty? %>
          <!-- Safety Message for New Chat -->
          <div class="mx-auto max-w-md my-4">
            <%= render "shared/alert_panel",
                variant: :info,
                icon: "‚ÑπÔ∏è",
                title: "L∆∞u √Ω an to√†n khi giao d·ªãch",
                items: [
                  "‚Ä¢ Ch·ªâ thanh to√°n khi ƒë√£ nh·∫≠n ƒë∆∞·ª£c h√†ng",
                  "‚Ä¢ H·∫πn g·∫∑p ·ªü n∆°i c√¥ng c·ªông, ƒë√¥ng ng∆∞·ªùi",
                  "‚Ä¢ Ki·ªÉm tra k·ªπ s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n",
                  "‚Ä¢ C·∫£nh gi√°c khi ƒë∆∞·ª£c ƒë·ªÅ ngh·ªã chuy·ªÉn ti·ªÅn tr∆∞·ªõc"
                ] %>
          </div>
        <% end %>
        
        <% @messages.each do |message| %>
          <%= render "messages/message", message: message, current_user: current_user %>
        <% end %>
      </div>
    </div>

    <!-- Quick Replies -->
    <div class="bg-white border-t border-gray-200 p-4" id="quick-replies-container">
      <% if current_user.first_trade? %>
        <p class="text-xs text-gray-600 mb-3 font-medium">üí¨ G·ª£i √Ω c√¢u h·ªèi cho giao d·ªãch ƒë·∫ßu ti√™n:</p>
      <% else %>
        <p class="text-xs text-gray-600 mb-3 font-medium">üí¨ Tr·∫£ l·ªùi nhanh:</p>
      <% end %>
      <div class="flex gap-3 flex-wrap" id="quick-replies">
        <% @quick_replies.group_by(&:category).first(3).each do |category, replies| %>
          <% reply = replies.first %>
          <button class="quick-reply-btn px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-colors min-h-[36px]" 
                  data-vi="<%= reply.content_vi %>" 
                  data-ko="<%= reply.content_ko %>">
            <%= current_user.locale == 'vi' ? reply.content_vi : reply.content_ko %>
          </button>
        <% end %>
        <button class="px-4 py-2 text-blue-600 hover:text-blue-800 text-sm font-medium" id="more-quick-replies">
          Th√™m ‚Üí
        </button>
      </div>
      
      <!-- Extended Quick Replies (hidden by default) -->
      <div class="hidden mt-2 space-y-2" id="extended-quick-replies">
        <% @quick_replies.group_by(&:category).each do |category, replies| %>
          <div>
            <p class="text-xs text-gray-500 mb-1">
              <%= case category
                  when 'greeting' then 'üëã Ch√†o h·ªèi'
                  when 'availability' then 'üì¶ T√¨nh tr·∫°ng'
                  when 'price' then 'üí∞ Gi√° c·∫£'
                  when 'location' then 'üìç ƒê·ªãa ƒëi·ªÉm'
                  when 'condition' then '‚úÖ Ch·∫•t l∆∞·ª£ng'
                  when 'thanks' then 'üôè C·∫£m ∆°n'
                  when 'interest' then 'üí¨ Quan t√¢m'
                  when 'meeting' then 'ü§ù H·∫πn g·∫∑p'
                  else category.humanize
                  end %>
            </p>
            <div class="flex gap-2 flex-wrap">
              <% replies.each do |reply| %>
                <button class="quick-reply-btn px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs transition-colors min-h-[32px]" 
                        data-vi="<%= reply.content_vi %>" 
                        data-ko="<%= reply.content_ko %>">
                  <%= current_user.locale == 'vi' ? reply.content_vi : reply.content_ko %>
                </button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Message Input -->
    <%= turbo_frame_tag "new_message", src: new_post_chat_room_message_path(@post, @chat_room), class: "bg-white rounded-b-lg shadow-sm p-4" do %>
      <%= form_with(model: [@post, @chat_room, @message], local: false) do |form| %>
        <div class="flex items-end space-x-2">
          <div class="flex-1">
            <%= form.text_area :content_raw, 
                rows: 1,
                placeholder: "Nh·∫≠p tin nh·∫Øn...",
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",
                data: { action: "input->message-input#adjustHeight" } %>
          </div>
          
          <%= form.submit "G·ª≠i", class: "px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium min-h-[44px]" %>
        </div>
        
        <% if @chat_room.buyer.locale != @chat_room.seller.locale %>
          <p class="text-xs text-gray-500 mt-2">
            <svg class="inline w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông d·ªãch
          </p>
        <% end %>
      <% end %>
    <% end %>
    
    <!-- Review CTA -->
    <% if @chat_room.can_be_reviewed_by?(current_user) %>
      <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-t border-blue-100">
        <% if current_user.reviews_given.count == 0 %>
          <!-- First review encouragement -->
          <div class="flex items-start gap-3 mb-3">
            <span class="text-2xl">üåü</span>
            <div>
              <p class="text-sm text-gray-700 font-medium">Giao d·ªãch ho√†n t·∫•t!</p>
              <p class="text-xs text-gray-600 mt-1">ƒê√°nh gi√° ch·ªâ m·∫•t 30 gi√¢y v√† gi√∫p x√¢y d·ª±ng c·ªông ƒë·ªìng tin c·∫≠y h∆°n.</p>
            </div>
          </div>
        <% else %>
          <p class="text-sm text-gray-700 mb-3 font-medium">‚ú® Giao d·ªãch ƒë√£ ho√†n t·∫•t!</p>
        <% end %>
        <%= link_to new_post_chat_room_review_path(@post, @chat_room), 
            class: "block text-center bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-medium transition-all transform hover:scale-[1.02] min-h-[44px] flex items-center justify-center gap-2 shadow-sm" do %>
          <span class="text-xl">üìù</span>
          <span><%= current_user.reviews_given.count == 0 ? "Vi·∫øt ƒë√°nh gi√° ƒë·∫ßu ti√™n" : "ƒê√°nh gi√° giao d·ªãch" %></span>
        <% end %>
        <% if current_user.reviews_given.count == 0 %>
          <p class="text-xs text-center text-gray-500 mt-2">üí° M·∫πo: ƒê√°nh gi√° t·ªët s·∫Ω gi√∫p b·∫°n nh·∫≠n ƒë∆∞·ª£c ƒë√°nh gi√° t√≠ch c·ª±c!</p>
        <% end %>
      </div>
    <% end %>
    
    <!-- Display Reviews -->
    <% if @chat_room.reviews.any? %>
      <div class="mt-4">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">ƒê√°nh gi√° giao d·ªãch</h4>
        <div class="space-y-3">
          <% @chat_room.reviews.includes(:reviewer, :reviewee).each do |review| %>
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                  <%= user_avatar(review.reviewer, size: "w-8 h-8", text_size: "text-sm") %>
                  <div>
                    <p class="font-medium text-gray-900 text-sm">
                      <%= review.reviewer.display_name %> ‚Üí <%= review.reviewee.display_name %>
                    </p>
                    <p class="text-xs text-gray-500"><%= time_ago_in_words(review.created_at) %> tr∆∞·ªõc</p>
                  </div>
                </div>
                <div class="flex items-center gap-1">
                  <% review.rating.times do %>
                    <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  <% end %>
                </div>
              </div>
              <% if review.comment.present? %>
                <p class="text-sm text-gray-700 mb-3"><%= review.comment %></p>
              <% end %>
              <% if review.visibility %>
                <%= render 'reviews/reaction_buttons', review: review %>
              <% else %>
                <p class="text-xs text-gray-500 italic">ƒê√°nh gi√° ri√™ng t∆∞</p>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Auto-scroll to bottom
  const messagesContainer = document.getElementById('messages');
  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  // Quick reply handling
  function setupQuickReplies() {
    document.querySelectorAll('.quick-reply-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const textarea = document.querySelector('textarea[name="message[content_raw]"]');
        const content = current_user_locale === 'vi' ? this.dataset.vi : this.dataset.ko;
        textarea.value = content;
        textarea.focus();
        
        // Optional: Auto-submit for quick replies
        // textarea.form.requestSubmit();
      });
    });
  }
  
  // Show more quick replies
  document.getElementById('more-quick-replies')?.addEventListener('click', function() {
    const extended = document.getElementById('extended-quick-replies');
    if (extended.classList.contains('hidden')) {
      extended.classList.remove('hidden');
      this.textContent = 'Thu g·ªçn ‚Üê';
    } else {
      extended.classList.add('hidden');
      this.textContent = 'Th√™m ‚Üí';
    }
  });

  // Setup quick replies on page load
  setupQuickReplies();
  
  // Store current user locale for JavaScript
  const current_user_locale = '<%= current_user.locale %>';

  // Auto-resize textarea
  document.addEventListener('turbo:load', () => {
    const textarea = document.querySelector('textarea[name="message[content_raw]"]');
    if (textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });
      
      // Submit on Enter (without Shift)
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.form.requestSubmit();
        }
      });
    }
  });
  
  // Auto-scroll on new messages
  document.addEventListener('turbo:frame-load', () => {
    const messages = document.getElementById('messages');
    if (messages) {
      messages.scrollTop = messages.scrollHeight;
    }
  });
</script>